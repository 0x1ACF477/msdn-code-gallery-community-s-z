<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
    <head><link rel="stylesheet" type="text/css" href="https://i-msdn.sec.s-msft.com/Combined.css?resources=0:Header,0:HeaderFooterSprite,0:Header.NonMtps;/Areas/Centers/Themes/StandardDevCenter/Content:0&amp;amp;v=46D0EADCABBE3E18DF970254C2C182AB" xmlns="http://www.w3.org/1999/xhtml" />
<link type="text/css" rel="stylesheet" xmlns="http://www.w3.org/1999/xhtml" />
<link rel="stylesheet" type="text/css" href="https://i-msdn.sec.s-msft.com/Combined.css?resources=0:Footer,0:HeaderFooterSprite,0:Footer.NonMtps,1:NewFooterSock,1:LinkList;/Areas/Centers/Themes/StandardDevCenter/Content:0,/Areas/Epx/Themes/Base/Content:1&amp;amp;v=D4D084DF03A9CB234D78334671AC996E" xmlns="http://www.w3.org/1999/xhtml" />
<link type="text/css" rel="stylesheet" xmlns="http://www.w3.org/1999/xhtml" />

        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>Speech To Text Bot using Microsoft Bot Framework and Cognitive Services [C#]</title>
        <link href="description/Galleries.css" type="text/css" rel="Stylesheet" /><link href="description/Layout.css" type="text/css" rel="Stylesheet" /><link href="description/Brand.css" type="text/css" rel="Stylesheet" />
        <link href="https://i1.code.msdn.s-msft.com/content/common/iframedescription.css" rel="Stylesheet" type="text/css" />
        <script src="https://i1.code.msdn.s-msft.com/content/common/offline.js" type="text/javascript"></script>
        <style type="text/css">
            #projectInfo {
                overflow: auto;
            }
            #longDesc {
                clear:both;
                margin: 25px 0 10px 0;
            }

            #SampleIndexList{
                margin-left: 15px;
            }
        </style>
    </head>
<body>
    <div id="offlineDescription">
        <h1>Speech To Text Bot using Microsoft Bot Framework and Cognitive Services [C#]</h1>
        <br/>
        <div id="projectInfo">
            <div class="section">
                    <div class="itemBarLong tagsContainer">
                        <label for="Technologies">Technologies</label>
                        <div id="Technologies">
                            Bing Speech, Microsoft Bot Framework, Cognitive Services
                        </div>
                    </div>
                    <div class="itemBarLong tagsContainer">
                        <label for="Topics">Topics</label>
                        <div id="Topics">
                            Bing Speech, Microsoft Bot Framework, Cognitive Services, Bots
                        </div>
                    </div>
                <div class="itemBarLong">
                    <label for="Platforms">Platforms</label>
                    <div id="Platforms">
                        Web
                    </div>
                </div>
                <div class="itemBarLong">
                    <label for="Requirements">Requirements</label>
                    <div id="Requirements">
                        
                    </div>
                </div>
                <div class="itemBar">
                    <label for="LastUpdated">Primary language</label>
                    <div id="LastUpdated">en-US</div>
                </div>
                <div class="itemBar">
                    <label for="LastUpdated">Updated</label>
                    <div id="LastUpdated">11/18/2016</div>
                </div>
                <div class="itemBarLong">
                    <label for="License">License</label>
                    <div id="License">
                        <a href="license.rtf">MIT</a></div>
                </div>
                <div class="itemBar">
                    <div class="viewonlinecont">
                        <a data-link="online" href="https://code.msdn.microsoft.com/Speech-To-Text-Bot-using-db55e1d0">View this sample online</a>
                    </div>
                </div>
            </div>
        </div>
        
                   
<script type="text/javascript">
    function initializePage() {
        var otherTabClass = 'otherTab';
        var hiddenPreClass = 'hidden';

        var htmlDecode = function(encodedData) {
            var decodedData = "";
            if (encodedData) {
                var div = document.createElement('div');
                div.innerHTML = encodedData;
                decodedData = div.firstChild.nodeValue.replace( /\\r\\n/ig , '\r\n');
            }
            return decodedData;
        };
                
        Galleries.iterateElem(Galleries.findElem(null, 'div', 'scriptcode'), function (index, scriptBlock) {
            var titleElem = Galleries.findElem(scriptBlock, 'div', 'title')[0];
            var labelElems = Galleries.findElem(titleElem, 'span');
            if (labelElems.length == 0) {
                labelElems = titleElem;
            }
            var languageSpans = Galleries.findElem(scriptBlock, 'span', 'hidden');
            var pres = Galleries.findElem(scriptBlock, 'pre');
            if (languageSpans.length > 0 && pres.length > 1) {
                Galleries.iterateElem(labelElems, function(index, elem) {
                    var codePre = pres[index];
                    var labelSpan = elem;
                    var languageSpan = languageSpans[index];
                            
                    elem.code = codePre.innerHTML.replace( /(\r(\n)?)|((\r)?\n)/ig , '\\r\\n');
                            
                    codePre.className = codePre.className.replace(hiddenPreClass, '');
                            
                    languageSpan.parentNode.removeChild(languageSpan);
                });

                pres = Galleries.findElem(scriptBlock, 'pre');
                Galleries.iterateElem(labelElems, function(index, elem) {
                    var codePre = pres[index];
                    var labelSpan = elem;
                    if (index == 0) {
                        scriptBlock.activeTab = 0;
                    }
                    else {
                        labelSpan.className += otherTabClass;
                        codePre.className += hiddenPreClass;
                    }
                    Galleries.attachEventHandler(labelSpan, 'click', function(e) {
                        var activeTab = scriptBlock.activeTab;
                        labelElems[activeTab].className += otherTabClass;
                        pres[activeTab].className += hiddenPreClass;

                        codePre.className = codePre.className.replace(hiddenPreClass, '');
                        labelSpan.className = labelSpan.className.replace(otherTabClass, '');
                        scriptBlock.activeTab = index;
                    });
                });

                var preview = Galleries.findElem(scriptBlock, 'div', 'preview');
                if (preview.length == 0) {
                    preview.push(pres[pres.length - 1]);
                }
                Galleries.iterateElem(preview, function(index, elem) {
                    elem.parentNode.removeChild(elem);
                });

                if (window.clipboardData && clipboardData.setData) {
                    var copyLink = document.createElement('a');
                    copyLink.href = 'javascript:void(0);';
                    copyLink.className = 'copyCode';
                    copyLink.innerHTML = 'Copy code';
                    Galleries.attachEventHandler(copyLink, 'click', function (e) {
                        clipboardData.setData("Text", htmlDecode(labelElems[scriptBlock.activeTab].code));
                        return false;
                    });
                    scriptBlock.insertBefore(copyLink, scriptBlock.childNodes[0]);
                }
            }
        });
    }

    Galleries.onWindowLoad(function(){
        initializePage();
    });

</script>
<div id="longDesc">
    
<h1>Speech To Text Bot Sample</h1>
<p>A sample bot that illustrates how to use the Microsoft Cognitive Services Bing Speech API to analyze an audio file and convert the audio stream to text. This Sample code could also be found in&nbsp;<a href="https://code.msdn.microsoft.com/Speech-To-Text-Bot-using-db55e1d0/https://github.com/Microsoft/BotBuilder-Samples/tree/master/CSharp/intelligence-SpeechToText">Github</a>.</p>
<h1>Prerequisites</h1>
<p><em>The minimum prerequisites to run this sample are:</em></p>
<ul>
<li>The latest update of Visual Studio 2015. You can download the community version&nbsp;<a href="http://www.visualstudio.com/">here</a>&nbsp;for free.
</li></ul>
<ul>
<li>The Bot Framework Emulator. To install the Bot Framework Emulator, download it from&nbsp;<a href="https://code.msdn.microsoft.com/Speech-To-Text-Bot-using-db55e1d0/https://aka.ms/bf-bc-emulator">here</a>. Please refer to&nbsp;<a href="https://code.msdn.microsoft.com/Speech-To-Text-Bot-using-db55e1d0/https://docs.botframework.com/en-us/csharp/builder/sdkreference/gettingstarted.html#emulator">this
 documentation article</a>&nbsp;to know more about the Bot Framework Emulator. </li><li>Bing Speech Api Key. You can obtain one from&nbsp;<a href="https://code.msdn.microsoft.com/Speech-To-Text-Bot-using-db55e1d0/https://code.msdn.microsoft.com/Speech-To-Text-Bot-using-db55e1d0/https://www.microsoft.com/cognitive-services/en-us/subscriptions?productId=/products/Bing.Speech.Preview">Microsoft Cognitive Services Subscriptions Page</a>.
</li><li>This sample currently uses a free trial Microsoft Cognitive service key with limited QPS. Please subscribe to Bing Speech Api services
<span><a href="https://code.msdn.microsoft.com/Speech-To-Text-Bot-using-db55e1d0/https://www.microsoft.com/cognitive-services/en-us/subscriptions">here</a></span>&nbsp;and update the
<strong>MicrosoftSpeechApiKey</strong>&nbsp;key in key in the <em>Web.config</em>&nbsp;file to try it out further.
</li></ul>
<h1>Usage</h1>
<p>Attach an audio file (wav format) and send an optional command as text.&nbsp;</p>
<p>Supported Commands:</p>
<ul>
<li>WORD - Counts the number of words. </li><li>CHARACTER - Counts the number of characters excluding spaces. </li><li>SPACE - Counts the number of spaces. </li><li>VOWEL - Counts the number of vowels. </li><li>Any other word will count the occurrences of that word in the transcribed text
</li></ul>
<h1>Code Highlights</h1>
<p>Microsoft Cognitive Services provides a Speech Recognition API to convert audio into text. Check out&nbsp;<a href="https://code.msdn.microsoft.com/Speech-To-Text-Bot-using-db55e1d0/https://code.msdn.microsoft.com/Speech-To-Text-Bot-using-db55e1d0/https://www.microsoft.com/cognitive-services/en-us/speech-api">Bing Speech API</a>&nbsp;for a complete reference of Speech APIs available.
 In this sample we are using the Speech Recognition API using the&nbsp;<a href="https://code.msdn.microsoft.com/Speech-To-Text-Bot-using-db55e1d0/https://www.microsoft.com/cognitive-services/en-us/Speech-api/documentation/API-Reference-REST/BingVoiceRecognition">REST API</a>.</p>
<p>In this sample we are using the API to get the text and send it back to the user. Check out the use of the&nbsp;<em>MicrosoftCognitiveSpeechService.GetTextFromAudioAsync()</em>&nbsp;method in the
<em>Controllers/MessagesController.cs</em> class.</p>
<div class="scriptcode">
<div class="scriptcode">
<div class="scriptcode">
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>C#</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">Edit</span>|<span class="pluginRemoveHolderLink">Remove</span></div>
<span class="hidden">csharp</span>
<pre class="hidden">var audioAttachment = activity.Attachments?.FirstOrDefault(a =&gt; a.ContentType.Equals(&quot;audio/wav&quot;));
if (audioAttachment != null)
{
    using (var client = new HttpClient())
    {
        var stream = await client.GetStreamAsync(audioAttachment.ContentUrl);
        var text = await this.speechService.GetTextFromAudioAsync(stream);
        message = ProcessText(activity.Text, text);
    }
}</pre>
<div class="preview">
<pre class="csharp">var&nbsp;audioAttachment&nbsp;=&nbsp;activity.Attachments?.FirstOrDefault(a&nbsp;=&gt;&nbsp;a.ContentType.Equals(<span class="cs__string">&quot;audio/wav&quot;</span>));&nbsp;
<span class="cs__keyword">if</span>&nbsp;(audioAttachment&nbsp;!=&nbsp;<span class="cs__keyword">null</span>)&nbsp;
{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__keyword">using</span>&nbsp;(var&nbsp;client&nbsp;=&nbsp;<span class="cs__keyword">new</span>&nbsp;HttpClient())&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;stream&nbsp;=&nbsp;await&nbsp;client.GetStreamAsync(audioAttachment.ContentUrl);&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;text&nbsp;=&nbsp;await&nbsp;<span class="cs__keyword">this</span>.speechService.GetTextFromAudioAsync(stream);&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;message&nbsp;=&nbsp;ProcessText(activity.Text,&nbsp;text);&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
}</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<p>and here is the implementation of <em>MicrosoftCognitiveSpeechService.GetTextFromAudioAsync()</em> in
<em>Services/MicrosoftCognitiveSpeechService.cs</em></p>
<div class="scriptcode">
<div class="scriptcode">
<div class="scriptcode">
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>C#</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">Edit</span>|<span class="pluginRemoveHolderLink">Remove</span></div>
<span class="hidden">csharp</span>
<pre class="hidden">````C#
/// &lt;summary&gt;
/// Gets text from an audio stream.
/// &lt;/summary&gt;
/// &lt;param name=&quot;audiostream&quot;&gt;&lt;/param&gt;
/// &lt;returns&gt;Transcribed text. &lt;/returns&gt;
public async Task&lt;string&gt; GetTextFromAudioAsync(Stream audiostream)
{
    var requestUri = @&quot;https://speech.platform.bing.com/recognize?scenarios=smd&amp;appid=D4D52672-91D7-4C74-8AD8-42B1D98141A5&amp;locale=en-US&amp;device.os=bot&amp;version=3.0&amp;format=json&amp;instanceid=565D69FF-E928-4B7E-87DA-9A750B96D9E3&amp;requestid=&quot; &#43; Guid.NewGuid();

    using (var client = new HttpClient())
    {
        var token = Authentication.Instance.GetAccessToken();
        client.DefaultRequestHeaders.Add(&quot;Authorization&quot;, &quot;Bearer &quot; &#43; token.access_token);

        using (var binaryContent = new ByteArrayContent(StreamToBytes(audiostream)))
        {
            binaryContent.Headers.TryAddWithoutValidation(&quot;content-type&quot;, &quot;audio/wav; codec=\&quot;audio/pcm\&quot;; samplerate=16000&quot;);

            var response = await client.PostAsync(requestUri, binaryContent);
            var responseString = await response.Content.ReadAsStringAsync();
            dynamic data = JsonConvert.DeserializeObject(responseString);
            return data.header.name;
        }
    }
}</pre>
<div class="preview">
<pre class="csharp">````C#&nbsp;
<span class="cs__com">///&nbsp;&lt;summary&gt;</span>&nbsp;
<span class="cs__com">///&nbsp;Gets&nbsp;text&nbsp;from&nbsp;an&nbsp;audio&nbsp;stream.</span>&nbsp;
<span class="cs__com">///&nbsp;&lt;/summary&gt;</span>&nbsp;
<span class="cs__com">///&nbsp;&lt;param&nbsp;name=&quot;audiostream&quot;&gt;&lt;/param&gt;</span>&nbsp;
<span class="cs__com">///&nbsp;&lt;returns&gt;Transcribed&nbsp;text.&nbsp;&lt;/returns&gt;</span>&nbsp;
<span class="cs__keyword">public</span>&nbsp;async&nbsp;Task&lt;<span class="cs__keyword">string</span>&gt;&nbsp;GetTextFromAudioAsync(Stream&nbsp;audiostream)&nbsp;
{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;requestUri&nbsp;=&nbsp;@<span class="cs__string">&quot;https://speech.platform.bing.com/recognize?scenarios=smd&amp;appid=D4D52672-91D7-4C74-8AD8-42B1D98141A5&amp;locale=en-US&amp;device.os=bot&amp;version=3.0&amp;format=json&amp;instanceid=565D69FF-E928-4B7E-87DA-9A750B96D9E3&amp;requestid=&quot;</span>&nbsp;&#43;&nbsp;Guid.NewGuid();&nbsp;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__keyword">using</span>&nbsp;(var&nbsp;client&nbsp;=&nbsp;<span class="cs__keyword">new</span>&nbsp;HttpClient())&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;token&nbsp;=&nbsp;Authentication.Instance.GetAccessToken();&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;client.DefaultRequestHeaders.Add(<span class="cs__string">&quot;Authorization&quot;</span>,&nbsp;<span class="cs__string">&quot;Bearer&nbsp;&quot;</span>&nbsp;&#43;&nbsp;token.access_token);&nbsp;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__keyword">using</span>&nbsp;(var&nbsp;binaryContent&nbsp;=&nbsp;<span class="cs__keyword">new</span>&nbsp;ByteArrayContent(StreamToBytes(audiostream)))&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;binaryContent.Headers.TryAddWithoutValidation(<span class="cs__string">&quot;content-type&quot;</span>,&nbsp;<span class="cs__string">&quot;audio/wav;&nbsp;codec=\&quot;audio/pcm\&quot;;&nbsp;samplerate=16000&quot;</span>);&nbsp;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;response&nbsp;=&nbsp;await&nbsp;client.PostAsync(requestUri,&nbsp;binaryContent);&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;responseString&nbsp;=&nbsp;await&nbsp;response.Content.ReadAsStringAsync();&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dynamic&nbsp;data&nbsp;=&nbsp;JsonConvert.DeserializeObject(responseString);&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__keyword">return</span>&nbsp;data.header.name;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
}</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<h1>Outcome</h1>
<p>You will see the following when connecting the Bot to the Emulator and send it an audio file and a command:</p>
<p>Input:</p>
<p>Audio file:&nbsp;audio/whatstheweatherlike.wav</p>
<p>Output:</p>
<p><img id="163715" src="description/outcome-emulator.png" alt="" width="1010" height="761"></p>
<h1>More Information</h1>
<p>To get more information about how to get started in Bot Builder for .NET and Microsoft Cognitive Services Bing Speech API please review the following resources:</p>
<ul>
<li><a href="https://code.msdn.microsoft.com/Speech-To-Text-Bot-using-db55e1d0/https://code.msdn.microsoft.com/Speech-To-Text-Bot-using-db55e1d0/https://docs.botframework.com/en-us/csharp/builder/sdkreference/index.html"></a><a href="https://code.msdn.microsoft.com/Speech-To-Text-Bot-using-db55e1d0/https://code.msdn.microsoft.com/Speech-To-Text-Bot-using-db55e1d0/https://docs.botframework.com/en-us/node/builder/overview/#navtitle"></a><a href="https://code.msdn.microsoft.com/Speech-To-Text-Bot-using-db55e1d0/https://code.msdn.microsoft.com/Speech-To-Text-Bot-using-db55e1d0/https://docs.botframework.com/en-us/node/builder/overview/#navtitle"></a><a href="https://code.msdn.microsoft.com/Speech-To-Text-Bot-using-db55e1d0/https://code.msdn.microsoft.com/Speech-To-Text-Bot-using-db55e1d0/https://docs.botframework.com/en-us/csharp/builder/sdkreference/index.html">Bot
 Builder for .NET</a> </li><li><a href="https://code.msdn.microsoft.com/Speech-To-Text-Bot-using-db55e1d0/https://github.com/Microsoft/Cognitive-vision-windows"></a><a href="https://code.msdn.microsoft.com/Speech-To-Text-Bot-using-db55e1d0/https://www.microsoft.com/cognitive-services/en-us/computer-vision-api"></a><a href="https://code.msdn.microsoft.com/Speech-To-Text-Bot-using-db55e1d0/https://code.msdn.microsoft.com/Speech-To-Text-Bot-using-db55e1d0/https://www.microsoft.com/cognitive-services/en-us/speech-api">Microsoft Cognitive Services
 Bing Speech API</a> </li></ul>

</div>


    </div>
</body>
</html>
