<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
    <head><link rel="stylesheet" type="text/css" href="https://i-msdn.sec.s-msft.com/Combined.css?resources=0:Header,0:HeaderFooterSprite,0:Header.NonMtps;/Areas/Centers/Themes/StandardDevCenter/Content:0&amp;amp;v=0F22413366F5977978C46D94D86B40A8" xmlns="http://www.w3.org/1999/xhtml" />
<link type="text/css" rel="stylesheet" xmlns="http://www.w3.org/1999/xhtml" />
<link rel="stylesheet" type="text/css" href="https://i-msdn.sec.s-msft.com/Combined.css?resources=0:Footer,0:HeaderFooterSprite,0:Footer.NonMtps,1:NewFooterSock,1:LinkList;/Areas/Centers/Themes/StandardDevCenter/Content:0,/Areas/Epx/Themes/Base/Content:1&amp;amp;v=BA54336BC791F42AE754C419920C1AAE" xmlns="http://www.w3.org/1999/xhtml" />
<link type="text/css" rel="stylesheet" xmlns="http://www.w3.org/1999/xhtml" />

        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>Unit testing sending emails</title>
        <link href="description/Galleries.css" type="text/css" rel="Stylesheet" /><link href="description/Layout.css" type="text/css" rel="Stylesheet" /><link href="description/Brand.css" type="text/css" rel="Stylesheet" />
        <link href="https://i1.code.msdn.s-msft.com/content/common/iframedescription.css" rel="Stylesheet" type="text/css" />
        <script src="https://i1.code.msdn.s-msft.com/content/common/offline.js" type="text/javascript"></script>
        <style type="text/css">
            #projectInfo {
                overflow: auto;
            }
            #longDesc {
                clear:both;
                margin: 25px 0 10px 0;
            }

            #SampleIndexList{
                margin-left: 15px;
            }
        </style>
    </head>
<body>
    <div id="offlineDescription">
        <h1>Unit testing sending emails</h1>
        <br/>
        <div id="projectInfo">
            <div class="section">
                    <div class="itemBarLong tagsContainer">
                        <label for="Technologies">Technologies</label>
                        <div id="Technologies">
                            Unit Test, eml conversion, Email Processing in C#
                        </div>
                    </div>
                    <div class="itemBarLong tagsContainer">
                        <label for="Topics">Topics</label>
                        <div id="Topics">
                            C#, Unit Testing, eml conversion
                        </div>
                    </div>
                <div class="itemBarLong">
                    <label for="Platforms">Platforms</label>
                    <div id="Platforms">
                        Desktop, Web
                    </div>
                </div>
                <div class="itemBarLong">
                    <label for="Requirements">Requirements</label>
                    <div id="Requirements">
                        
                    </div>
                </div>
                <div class="itemBar">
                    <label for="LastUpdated">Primary language</label>
                    <div id="LastUpdated">en-US</div>
                </div>
                <div class="itemBar">
                    <label for="LastUpdated">Updated</label>
                    <div id="LastUpdated">6/21/2017</div>
                </div>
                <div class="itemBarLong">
                    <label for="License">License</label>
                    <div id="License">
                        <a href="license.rtf">MIT</a></div>
                </div>
                <div class="itemBar">
                    <div class="viewonlinecont">
                        <a data-link="online" href="https://code.msdn.microsoft.com/Unit-testing-sending-emails-222f3ad9">View this sample online</a>
                    </div>
                </div>
            </div>
        </div>
        
                   
<script type="text/javascript">
    function initializePage() {
        var otherTabClass = 'otherTab';
        var hiddenPreClass = 'hidden';

        var htmlDecode = function(encodedData) {
            var decodedData = "";
            if (encodedData) {
                var div = document.createElement('div');
                div.innerHTML = encodedData;
                decodedData = div.firstChild.nodeValue.replace( /\\r\\n/ig , '\r\n');
            }
            return decodedData;
        };
                
        Galleries.iterateElem(Galleries.findElem(null, 'div', 'scriptcode'), function (index, scriptBlock) {
            var titleElem = Galleries.findElem(scriptBlock, 'div', 'title')[0];
            var labelElems = Galleries.findElem(titleElem, 'span');
            if (labelElems.length == 0) {
                labelElems = titleElem;
            }
            var languageSpans = Galleries.findElem(scriptBlock, 'span', 'hidden');
            var pres = Galleries.findElem(scriptBlock, 'pre');
            if (languageSpans.length > 0 && pres.length > 1) {
                Galleries.iterateElem(labelElems, function(index, elem) {
                    var codePre = pres[index];
                    var labelSpan = elem;
                    var languageSpan = languageSpans[index];
                            
                    elem.code = codePre.innerHTML.replace( /(\r(\n)?)|((\r)?\n)/ig , '\\r\\n');
                            
                    codePre.className = codePre.className.replace(hiddenPreClass, '');
                            
                    languageSpan.parentNode.removeChild(languageSpan);
                });

                pres = Galleries.findElem(scriptBlock, 'pre');
                Galleries.iterateElem(labelElems, function(index, elem) {
                    var codePre = pres[index];
                    var labelSpan = elem;
                    if (index == 0) {
                        scriptBlock.activeTab = 0;
                    }
                    else {
                        labelSpan.className += otherTabClass;
                        codePre.className += hiddenPreClass;
                    }
                    Galleries.attachEventHandler(labelSpan, 'click', function(e) {
                        var activeTab = scriptBlock.activeTab;
                        labelElems[activeTab].className += otherTabClass;
                        pres[activeTab].className += hiddenPreClass;

                        codePre.className = codePre.className.replace(hiddenPreClass, '');
                        labelSpan.className = labelSpan.className.replace(otherTabClass, '');
                        scriptBlock.activeTab = index;
                    });
                });

                var preview = Galleries.findElem(scriptBlock, 'div', 'preview');
                if (preview.length == 0) {
                    preview.push(pres[pres.length - 1]);
                }
                Galleries.iterateElem(preview, function(index, elem) {
                    elem.parentNode.removeChild(elem);
                });

                if (window.clipboardData && clipboardData.setData) {
                    var copyLink = document.createElement('a');
                    copyLink.href = 'javascript:void(0);';
                    copyLink.className = 'copyCode';
                    copyLink.innerHTML = 'Copy code';
                    Galleries.attachEventHandler(copyLink, 'click', function (e) {
                        clipboardData.setData("Text", htmlDecode(labelElems[scriptBlock.activeTab].code));
                        return false;
                    });
                    scriptBlock.insertBefore(copyLink, scriptBlock.childNodes[0]);
                }
            }
        });
    }

    Galleries.onWindowLoad(function(){
        initializePage();
    });

</script>
<div id="longDesc">
    
<h1>Description</h1>
<p><span style="font-size:small">This code sample is about unit testing email operations. &nbsp;</span></p>
<p><span style="font-size:small">IMPORTANT: Before jumping into this please understand that it may take some time to properly this up for your solution. High level, you don't need the two projects MsgKit and MsgReader in your solution but instead install them.
 What you do need is a single project which is EmailConverters (which use both MsgKit and MsgReader).</span></p>
<p><span style="color:#ffffff; font-size:small">.</span></p>
<p><strong><span style="font-size:small">UPDATE 1&nbsp;</span></strong><span style="font-size:small">I have re-uploaded the solution without MsgKit and MsgReader source project, added in the packages which I exlcuded the first time as this made the download
 smaller but caused issues upon compiling as the packages where not being restored. Have tested this upload and works fine.</span></p>
<p><span style="font-size:small">.</span></p>
<p><span style="font-size:small"><strong>UPDATE 2</strong> Working on extracting attachments from .eml files, coming soon.</span></p>
<p>&nbsp;</p>
<p><span style="font-size:small">To install the packages below, in your solution, select Tools menu in Visual Studio, select Package Manager Console and enter the commands below.</span></p>
<p><span style="font-size:small"><img id="174282" src="description/1111.jpg" alt="" width="622" height="71"><br>
</span></p>
<p><span style="font-size:small">MsgReader:&nbsp;Install-Package MSGReader -Version 2.0.11</span></p>
<p><span style="font-size:small">MsgKit:&nbsp;Install-Package MsgKit -Version 1.0.0</span></p>
<p><span style="font-size:small">NOTE: MimeKit and OpenMcDf packages will be installed by the above.</span></p>
<p><br>
<span style="font-size:small">A simple unit test would be to send email messages using SmtpClient and MailMessage classes where you would setup DeliveryMethod and PickupDirectoryLocation for the SmtpClient, send the message, open the pickup location, open the
 .eml file generated and validate the information is correct or just do a file count of the folder to ensure there is a .eml file.</span></p>
<p><br>
<span style="font-size:small">One step up is to send the message as per above then open the file via the .NET File class and search for information e.g. from, to, cc, subject, body.</span></p>
<p><br>
<span style="font-size:small">Here I&rsquo;ve notice over the years many developers struggle with reading .eml files, it&rsquo;s messy and takes a good deal of code.</span></p>
<p><span style="font-size:small">&nbsp;</span><br>
<span style="font-size:small">What I&rsquo;m presenting uses two libraries found on GitHub, both are from the same author. The first, MsgKit creates (for this code sample) .msg message files which then are read using strong typed classes from the other library
 MsgReader.</span></p>
<p><br>
<span style="font-size:small">I take both libraries and incorporate them into a class project which makes creating a folder of .eml files into .msg files then parse the email files, in some cases down to HTML elements in the message body using yet another library
 HTML Agility pack.</span></p>
<p>&nbsp;</p>
<p><span style="font-size:small">Let's run through what is included (excluding the MsgKit and MsgReader), DesktopCreateEmlFiles is a desktop forms project. Here you can see the pattern for generating .eml files which are placed into a folder below the executable
 folder. The top CheckedListBox is for the TO address, the second for CC. They are followed by Subject, From and to the right creating a simple body. Press the Send button to create the .eml file. Press the Folder button to open the folder.</span></p>
<p><span style="font-size:small"><img id="174283" src="description/222.jpg" alt="" width="680" height="352"><br>
</span></p>
<p><span style="font-size:small">In regards to the folder where the .eml files are generated, I use a Post build command to ensure the folder exists.</span></p>
<p><span style="font-size:small"><img id="174284" src="description/333.jpg" alt="" width="430" height="101"></span></p>
<p>&nbsp;</p>
<p><span style="font-size:small"><strong>IMPORTANT</strong>: You would not use a forms project to generate your email messages but instead write unit test against your production services. In your class responsible for sending email messages you could check
 for the existance of a folder such as MailDrop, if it exists, use the setup I have in MailOperations and if the folder does not exists actually send the mail.&nbsp;</span></p>
<p><span style="font-size:small">Our team has such a class which is to complicated to use in this code sample as it relies on NInject and several custom base repositories.</span></p>
<p><span style="font-size:small">Okay, all data is stored in SQL-Server where I include a script to generate the database and two tables.</span></p>
<p><span style="font-size:small"><img id="174285" src="description/4444.jpg" alt="" width="184" height="276"><br>
</span></p>
<p><span style="font-size:small">After generating the data via Script.sql, alter the server in DataOperations e.g. I have it set to KARENS-PC, you might change it to say .\SQLEXPRESS&nbsp;</span></p>
<p><span style="font-size:x-small"><img id="174286" src="description/55555.jpg" alt="" width="340" height="113"><br>
</span></p>
<p><span style="font-size:small">&nbsp;</span></p>
<p><span style="font-size:small">Next I will focus on the conversion from eml to msg file via the following class. There is a good deal of code but there is one line that does the magic, the rest is reading the folder, getting file names (we generally will
 create one to 30 email files in a single unit test), generate the msg files and remove the eml files to keep things clean (there is another class dedicated to cleaning house).</span></p>
<p><span style="font-size:small">The magic line</span></p>
<p>&nbsp;</p>
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>C#</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">Edit</span>|<span class="pluginRemoveHolderLink">Remove</span></div>
<span class="hidden">csharp</span>
<pre class="hidden">MsgKit.Converter.ConvertEmlToMsg(file, Path.ChangeExtension(file, &quot;.msg&quot;));</pre>
<div class="preview">
<pre class="js">MsgKit.Converter.ConvertEmlToMsg(file,&nbsp;Path.ChangeExtension(file,&nbsp;<span class="js__string">&quot;.msg&quot;</span>));</pre>
</div>
</div>
</div>
<div class="endscriptcode"><span style="font-size:small">&nbsp;In FromEml class (which the above line is from) I've set it up so that if there are failures you can get them via properties if a method returns ToMsgResult for errors.</span></div>
<div class="endscriptcode"></div>
<div class="endscriptcode">
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>C#</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">Edit</span>|<span class="pluginRemoveHolderLink">Remove</span></div>
<span class="hidden">csharp</span>
<pre class="hidden">public enum ToMsgResult 
{
    Success,
    FailedWithException,
    FolderNotFound
}</pre>
<div class="preview">
<pre class="js">public&nbsp;enum&nbsp;ToMsgResult&nbsp;&nbsp;
<span class="js__brace">{</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;Success,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;FailedWithException,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;FolderNotFound&nbsp;
<span class="js__brace">}</span></pre>
</div>
</div>
</div>
<div class="endscriptcode"><span style="font-size:small">There is a good deal going on in this class and one might wonder, is this slow? I converted 30 .eml files in 178ms, not bad and as mentioned above there are clean up methods to clean up both eml and
 msg messages when running your unit test.</span></div>
<div class="endscriptcode"><span style="font-size:small"><br>
</span></div>
<div class="endscriptcode"><img id="174287" src="description/66666.jpg" alt="" width="313" height="119"></div>
<div class="endscriptcode"></div>
<div class="endscriptcode"><span style="font-size:small">For demoing the above I created only four test (that's plenty once you look them over). To keep things easy to follow I created .eml files in different folders, some with meaningful names (which you
 can't do in a real unit test).</span></div>
<div class="endscriptcode"></div>
<div class="endscriptcode"><span style="font-size:small">Generated by unit test.</span></div>
<div class="endscriptcode"><span style="font-size:small"><img id="174288" src="description/77777.jpg" alt="" width="273" height="75"><br>
</span></div>
<div class="endscriptcode"></div>
<div class="endscriptcode"><span style="font-size:small">Should have shown this before, what a .eml looks like raw.</span></div>
<div class="endscriptcode"><span style="font-size:small">
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>HTML</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">Edit</span>|<span class="pluginRemoveHolderLink">Remove</span></div>
<span class="hidden">html</span>
<pre class="hidden">X-Sender: WEBDEV.webdev@somewhere.com
X-Receiver: first@comcast.net
MIME-Version: 1.0
From: WEBDEV.webdev@somewhere.com
To: first@comcast.net
Date: 25 May 2017 14:15:49 -0700
Subject: Class completion notification
Content-Type: text/html; charset=us-ascii
Content-Transfer-Encoding: quoted-printable

&lt;p&gt;Martha Adams has been completed the course Tuna Apprasing on t=
he following dates.&lt;/p&gt;&lt;ul&gt;&lt;li&gt;Sunday, February 12, 2017&lt;/li&gt;&lt;li&gt;=
Thursday, May 25, 2017&lt;/li&gt;&lt;/ul&gt;
</pre>
<div class="preview">
<pre class="js">X-Sender:&nbsp;WEBDEV.webdev@somewhere.com&nbsp;
X-Receiver:&nbsp;first@comcast.net&nbsp;
MIME-Version:&nbsp;<span class="js__num">1.0</span>&nbsp;
From:&nbsp;WEBDEV.webdev@somewhere.com&nbsp;
To:&nbsp;first@comcast.net&nbsp;
<span class="js__object">Date</span>:&nbsp;<span class="js__num">25</span>&nbsp;May&nbsp;<span class="js__num">2017</span>&nbsp;<span class="js__num">14</span>:<span class="js__num">15</span>:<span class="js__num">49</span>&nbsp;-<span class="js__num">0700</span>&nbsp;
Subject:&nbsp;Class&nbsp;completion&nbsp;notification&nbsp;
Content-Type:&nbsp;text/html;&nbsp;charset=us-ascii&nbsp;
Content-Transfer-Encoding:&nbsp;quoted-printable&nbsp;
&nbsp;
&lt;p&gt;Martha&nbsp;Adams&nbsp;has&nbsp;been&nbsp;completed&nbsp;the&nbsp;course&nbsp;Tuna&nbsp;Apprasing&nbsp;on&nbsp;t=&nbsp;
he&nbsp;following&nbsp;dates.&lt;<span class="js__reg_exp">/p&gt;&lt;ul&gt;&lt;li&gt;Sunday,&nbsp;February&nbsp;12,&nbsp;2017&lt;/</span>li&gt;&lt;li&gt;=&nbsp;
Thursday,&nbsp;May&nbsp;<span class="js__num">25</span>,&nbsp;<span class="js__num">2017</span>&lt;<span class="js__reg_exp">/li&gt;&lt;/</span>ul&gt;&nbsp;
</pre>
</div>
</div>
</div>
<div class="endscriptcode">&nbsp;</div>
Not pretty, .msg file is binary so I will not show it here.<br>
</span></div>
<div class="endscriptcode"></div>
<div class="endscriptcode"><span style="font-size:small">When and if you get deep enough to parse the body of an email using HTML Agility pack trust me, the debugger and local window are your friends to traverse the elements and figure out where things are.
 The following code exempifies this as I would had not gotten this without the local window.</span></div>
<div class="endscriptcode"></div>
<div class="endscriptcode"><span style="font-size:small">
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>C#</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">Edit</span>|<span class="pluginRemoveHolderLink">Remove</span></div>
<span class="hidden">csharp</span>
<pre class="hidden">HtmlAgilityPack.HtmlDocument htmlDoc = new HtmlAgilityPack.HtmlDocument();
htmlDoc.LoadHtml(singleMailInformation.BodyAsHTML);

// Validate the link
Assert.IsTrue(
    htmlDoc.DocumentNode.ChildNodes.FirstOrDefault()
        .ChildNodes.FirstOrDefault().NextSibling.OuterHtml == expectedLink);</pre>
<div class="preview">
<pre class="js">HtmlAgilityPack.HtmlDocument&nbsp;htmlDoc&nbsp;=&nbsp;<span class="js__operator">new</span>&nbsp;HtmlAgilityPack.HtmlDocument();&nbsp;
htmlDoc.LoadHtml(singleMailInformation.BodyAsHTML);&nbsp;
&nbsp;
<span class="js__sl_comment">//&nbsp;Validate&nbsp;the&nbsp;link</span>&nbsp;
Assert.IsTrue(&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;htmlDoc.DocumentNode.ChildNodes.FirstOrDefault()&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.ChildNodes.FirstOrDefault().NextSibling.OuterHtml&nbsp;==&nbsp;expectedLink);</pre>
</div>
</div>
</div>
<div class="endscriptcode">In closing, I hope this provides those looking for a better way to validate what is in an .eml file and better method. And this is not simply for unit test, you might need to do some sort of mass folder conversion and this would
 be helpful for that too.&nbsp;</div>
<br>
</span></div>
</div>
<div class="endscriptcode"><span style="font-size:small"><br>
</span></div>
<p>&nbsp;</p>
<p><span style="font-size:small"><br>
</span></p>
<p><span style="font-size:small"><br>
</span></p>

</div>


    </div>
</body>
</html>
