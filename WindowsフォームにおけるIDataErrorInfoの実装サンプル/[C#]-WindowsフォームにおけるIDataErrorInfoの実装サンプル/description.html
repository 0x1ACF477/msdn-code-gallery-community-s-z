<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
    <head><link rel="stylesheet" type="text/css" href="https://i-msdn.sec.s-msft.com/Combined.css?resources=0:Header,0:HeaderFooterSprite,0:Header.NonMtps,1:LinkList;/Areas/Centers/Themes/StandardDevCenter/Content:0,/Areas/Epx/Themes/Base/Content:1&amp;amp;v=1305A6FDA762B39EF3890756F790CC42" xmlns="http://www.w3.org/1999/xhtml" />
<link type="text/css" rel="stylesheet" xmlns="http://www.w3.org/1999/xhtml" />
<link rel="stylesheet" type="text/css" href="https://i-msdn.sec.s-msft.com/Combined.css?resources=0:Footer,0:HeaderFooterSprite,0:Footer.NonMtps,1:FooterSock,1:LinkList;/Areas/Centers/Themes/StandardDevCenter/Content:0,/Areas/Epx/Themes/Base/Content:1&amp;amp;v=7D55C467F3C93EE89524C04B6E9D8586" xmlns="http://www.w3.org/1999/xhtml" />
<link type="text/css" rel="stylesheet" xmlns="http://www.w3.org/1999/xhtml" />

        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>WindowsフォームにおけるIDataErrorInfoの実装サンプル</title>
        <link href="description/Galleries.css" type="text/css" rel="Stylesheet" /><link href="description/Layout.css" type="text/css" rel="Stylesheet" /><link href="description/Brand.css" type="text/css" rel="Stylesheet" />
        <link href="https://i1.code.msdn.s-msft.com/content/common/iframedescription.css" rel="Stylesheet" type="text/css" />
        <script src="https://i1.code.msdn.s-msft.com/content/common/offline.js" type="text/javascript"></script>
        <style type="text/css">
            #projectInfo {
                overflow: auto;
            }
            #longDesc {
                clear:both;
                margin: 25px 0 10px 0;
            }

            #SampleIndexList{
                margin-left: 15px;
            }
        </style>
    </head>
<body>
    <div id="offlineDescription">
        <h1>WindowsフォームにおけるIDataErrorInfoの実装サンプル</h1>
        <br/>
        <div id="projectInfo">
            <div class="section">
                    <div class="itemBarLong tagsContainer">
                        <label for="Technologies">Technologies</label>
                        <div id="Technologies">
                            C#, Windows Forms
                        </div>
                    </div>
                    <div class="itemBarLong tagsContainer">
                        <label for="Topics">Topics</label>
                        <div id="Topics">
                            C#, Data Binding, User Interface, Windows Forms, Windows &#12501;&#12457;&#12540;&#12512;, User Experience
                        </div>
                    </div>
                <div class="itemBarLong">
                    <label for="Platforms">Platforms</label>
                    <div id="Platforms">
                        Desktop
                    </div>
                </div>
                <div class="itemBarLong">
                    <label for="Requirements">Requirements</label>
                    <div id="Requirements">
                        
                    </div>
                </div>
                <div class="itemBar">
                    <label for="LastUpdated">Primary language</label>
                    <div id="LastUpdated">ja-JP</div>
                </div>
                <div class="itemBar">
                    <label for="LastUpdated">Updated</label>
                    <div id="LastUpdated">4/15/2015</div>
                </div>
                <div class="itemBarLong">
                    <label for="License">License</label>
                    <div id="License">
                        <a href="license.rtf">MIT</a></div>
                </div>
                <div class="itemBar">
                    <div class="viewonlinecont">
                        <a data-link="online" href="https://code.msdn.microsoft.com/WindowsIDataErrorInfo-637ebea1">View this sample online</a>
                    </div>
                </div>
            </div>
        </div>
        
                   
<script type="text/javascript">
    function initializePage() {
        var otherTabClass = 'otherTab';
        var hiddenPreClass = 'hidden';

        var htmlDecode = function(encodedData) {
            var decodedData = "";
            if (encodedData) {
                var div = document.createElement('div');
                div.innerHTML = encodedData;
                decodedData = div.firstChild.nodeValue.replace( /\\r\\n/ig , '\r\n');
            }
            return decodedData;
        };
                
        Galleries.iterateElem(Galleries.findElem(null, 'div', 'scriptcode'), function (index, scriptBlock) {
            var titleElem = Galleries.findElem(scriptBlock, 'div', 'title')[0];
            var labelElems = Galleries.findElem(titleElem, 'span');
            if (labelElems.length == 0) {
                labelElems = titleElem;
            }
            var languageSpans = Galleries.findElem(scriptBlock, 'span', 'hidden');
            var pres = Galleries.findElem(scriptBlock, 'pre');
            if (languageSpans.length > 0 && pres.length > 1) {
                Galleries.iterateElem(labelElems, function(index, elem) {
                    var codePre = pres[index];
                    var labelSpan = elem;
                    var languageSpan = languageSpans[index];
                            
                    elem.code = codePre.innerHTML.replace( /(\r(\n)?)|((\r)?\n)/ig , '\\r\\n');
                            
                    codePre.className = codePre.className.replace(hiddenPreClass, '');
                            
                    languageSpan.parentNode.removeChild(languageSpan);
                });

                pres = Galleries.findElem(scriptBlock, 'pre');
                Galleries.iterateElem(labelElems, function(index, elem) {
                    var codePre = pres[index];
                    var labelSpan = elem;
                    if (index == 0) {
                        scriptBlock.activeTab = 0;
                    }
                    else {
                        labelSpan.className += otherTabClass;
                        codePre.className += hiddenPreClass;
                    }
                    Galleries.attachEventHandler(labelSpan, 'click', function(e) {
                        var activeTab = scriptBlock.activeTab;
                        labelElems[activeTab].className += otherTabClass;
                        pres[activeTab].className += hiddenPreClass;

                        codePre.className = codePre.className.replace(hiddenPreClass, '');
                        labelSpan.className = labelSpan.className.replace(otherTabClass, '');
                        scriptBlock.activeTab = index;
                    });
                });

                var preview = Galleries.findElem(scriptBlock, 'div', 'preview');
                if (preview.length == 0) {
                    preview.push(pres[pres.length - 1]);
                }
                Galleries.iterateElem(preview, function(index, elem) {
                    elem.parentNode.removeChild(elem);
                });

                if (window.clipboardData && clipboardData.setData) {
                    var copyLink = document.createElement('a');
                    copyLink.href = 'javascript:void(0);';
                    copyLink.className = 'copyCode';
                    copyLink.innerHTML = 'Copy code';
                    Galleries.attachEventHandler(copyLink, 'click', function (e) {
                        clipboardData.setData("Text", htmlDecode(labelElems[scriptBlock.activeTab].code));
                        return false;
                    });
                    scriptBlock.insertBefore(copyLink, scriptBlock.childNodes[0]);
                }
            }
        });
    }

    Galleries.onWindowLoad(function(){
        initializePage();
    });

</script>
<div id="longDesc">
    
<h1>はじめに</h1>
<p>WindowsフォームにIDataErrorInfoを実装した例を示します。<br>
例えば、WindowsフォームにDataTableをバインドさせることが多いと思いますが、そもそもDataTableというのは非接続型のデータアクセスを実現するためにデザインされています。よって、必ずしも画面に直接バインドするオブジェクトとして適しているわけではありません。本来、非接続型でデータベースなどとデータのやり取りを行う部分のみに使うのが望ましいと思います。<br>
以上を理解していれば、DataTableを直接画面にバインドした際に不都合が出るのであれば、DataTableとは別に、画面にバインドする専用のオブジェクトを用意する発想に至るでしょう。<br>
ここでは、その例を示します。&nbsp;</p>
<p>&nbsp;</p>
<h1>本サンプルの環境</h1>
<p>本サンプルはVisual Studio 2013、C#、.NET Framework 4.5 で作成していますが、特殊なコードは書いていませんので、おそらく.NET Framework 3.0以降のC#で動作するでしょう。、</p>
<p>&nbsp;</p>
<p><span style="font-size:20px; font-weight:bold">説明</span></p>
<p>「はじめに」ではDataTableを例に出しましたが、ここでは簡単にするためにDataTableの代わりにModelクラスを用意します。</p>
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>C#</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">スクリプトの編集</span>|<span class="pluginRemoveHolderLink">Remove</span></div>
<span class="hidden">csharp</span>
<pre class="hidden">/// &lt;summary&gt;
/// データモデルクラス
/// &lt;/summary&gt;
public class Model
{
    public String A { get; set; }
    public int B { get; set; }
    public decimal C { get; set; }
}</pre>
<div class="preview">
<pre class="csharp"><span class="cs__com">///&nbsp;&lt;summary&gt;</span>&nbsp;
<span class="cs__com">///&nbsp;データモデルクラス</span>&nbsp;
<span class="cs__com">///&nbsp;&lt;/summary&gt;</span>&nbsp;
<span class="cs__keyword">public</span>&nbsp;<span class="cs__keyword">class</span>&nbsp;Model&nbsp;
{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__keyword">public</span>&nbsp;String&nbsp;A&nbsp;{&nbsp;<span class="cs__keyword">get</span>;&nbsp;<span class="cs__keyword">set</span>;&nbsp;}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__keyword">public</span>&nbsp;<span class="cs__keyword">int</span>&nbsp;B&nbsp;{&nbsp;<span class="cs__keyword">get</span>;&nbsp;<span class="cs__keyword">set</span>;&nbsp;}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__keyword">public</span>&nbsp;<span class="cs__keyword">decimal</span>&nbsp;C&nbsp;{&nbsp;<span class="cs__keyword">get</span>;&nbsp;<span class="cs__keyword">set</span>;&nbsp;}&nbsp;
}</pre>
</div>
</div>
</div>
<p>このModelクラスのバインド用クラスとして、UIObjectクラスを用意します。Modelクラスのプロパティを内包しています。画面上からは一旦、どのような値でも受け取れるように、それらすべてのプロパティはstring型になっています。<br>
また、HasErrorプロパティを追加しています。このプロパティは全体でエラーがあるかどうかを表します。同時に、HasErrorプロパティに変化があった際に発生するイベントも定義しています。 これを利用し、画面側ではエラーがある限り保存ボタンがグレーアウト（不活性化）し、保存ボタンが押せないように制御しています。</p>
<p>&nbsp;</p>
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>C#</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">スクリプトの編集</span>|<span class="pluginRemoveHolderLink">Remove</span></div>
<span class="hidden">csharp</span>
<pre class="hidden">/// &lt;summary&gt;
/// 画面にバインドするクラス
/// &lt;/summary&gt;
public class UIObject : IDataErrorInfo
{
    //エラー情報を保持
    private Dictionary&lt;string, string&gt; _errors = new Dictionary&lt;string, string&gt;();

    #region プロパティ

    string _A;
    public string A
    {
        get { return _A; }
        set
        {
            if (_A == value) return;
            _A = value;
            ValidateA();
        }
    }

    string _B;
    public string B
    {
        get { return _B; }
        set
        {
            if (_B == value) return;
            _B = value;
            ValidateB();
        }
    }

    string _C;
    public string C
    {
        get { return _C; }
        set
        {
            if (_C == value) return;
            _C = value;
            ValidateC();
        }
    }

    /// &lt;summary&gt;
    /// エラーの有無 
    /// &lt;/summary&gt;
    public bool HasError
    {
        get
        {
            return _errors.Count != 0;
        }
    }

    #endregion

    #region イベント

    public event Action&lt;bool&gt; HasErrorChanged;

    private void OnHasErrorChanged(bool hasError)
    {
        if (HasErrorChanged != null)
            HasErrorChanged(hasError);
    }

    #endregion

   　　　・
   　　　・
   　　　・
   　　（略）
}</pre>
<div class="preview">
<pre class="csharp"><span class="cs__com">///&nbsp;&lt;summary&gt;</span>&nbsp;
<span class="cs__com">///&nbsp;画面にバインドするクラス</span>&nbsp;
<span class="cs__com">///&nbsp;&lt;/summary&gt;</span>&nbsp;
<span class="cs__keyword">public</span>&nbsp;<span class="cs__keyword">class</span>&nbsp;UIObject&nbsp;:&nbsp;IDataErrorInfo&nbsp;
{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__com">//エラー情報を保持</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__keyword">private</span>&nbsp;Dictionary&lt;<span class="cs__keyword">string</span>,&nbsp;<span class="cs__keyword">string</span>&gt;&nbsp;_errors&nbsp;=&nbsp;<span class="cs__keyword">new</span>&nbsp;Dictionary&lt;<span class="cs__keyword">string</span>,&nbsp;<span class="cs__keyword">string</span>&gt;();<span class="cs__preproc">&nbsp;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;#region</span>&nbsp;プロパティ&nbsp;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__keyword">string</span>&nbsp;_A;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__keyword">public</span>&nbsp;<span class="cs__keyword">string</span>&nbsp;A&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__keyword">get</span>&nbsp;{&nbsp;<span class="cs__keyword">return</span>&nbsp;_A;&nbsp;}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__keyword">set</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__keyword">if</span>&nbsp;(_A&nbsp;==&nbsp;<span class="cs__keyword">value</span>)&nbsp;<span class="cs__keyword">return</span>;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_A&nbsp;=&nbsp;<span class="cs__keyword">value</span>;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ValidateA();&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__keyword">string</span>&nbsp;_B;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__keyword">public</span>&nbsp;<span class="cs__keyword">string</span>&nbsp;B&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__keyword">get</span>&nbsp;{&nbsp;<span class="cs__keyword">return</span>&nbsp;_B;&nbsp;}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__keyword">set</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__keyword">if</span>&nbsp;(_B&nbsp;==&nbsp;<span class="cs__keyword">value</span>)&nbsp;<span class="cs__keyword">return</span>;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_B&nbsp;=&nbsp;<span class="cs__keyword">value</span>;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ValidateB();&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__keyword">string</span>&nbsp;_C;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__keyword">public</span>&nbsp;<span class="cs__keyword">string</span>&nbsp;C&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__keyword">get</span>&nbsp;{&nbsp;<span class="cs__keyword">return</span>&nbsp;_C;&nbsp;}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__keyword">set</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__keyword">if</span>&nbsp;(_C&nbsp;==&nbsp;<span class="cs__keyword">value</span>)&nbsp;<span class="cs__keyword">return</span>;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_C&nbsp;=&nbsp;<span class="cs__keyword">value</span>;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ValidateC();&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__com">///&nbsp;&lt;summary&gt;</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__com">///&nbsp;エラーの有無&nbsp;</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__com">///&nbsp;&lt;/summary&gt;</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__keyword">public</span>&nbsp;<span class="cs__keyword">bool</span>&nbsp;HasError&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__keyword">get</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__keyword">return</span>&nbsp;_errors.Count&nbsp;!=&nbsp;<span class="cs__number">0</span>;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;}<span class="cs__preproc">&nbsp;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;#endregion</span><span class="cs__preproc">&nbsp;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;#region</span>&nbsp;イベント&nbsp;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__keyword">public</span>&nbsp;<span class="cs__keyword">event</span>&nbsp;Action&lt;<span class="cs__keyword">bool</span>&gt;&nbsp;HasErrorChanged;&nbsp;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__keyword">private</span>&nbsp;<span class="cs__keyword">void</span>&nbsp;OnHasErrorChanged(<span class="cs__keyword">bool</span>&nbsp;hasError)&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__keyword">if</span>&nbsp;(HasErrorChanged&nbsp;!=&nbsp;<span class="cs__keyword">null</span>)&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HasErrorChanged(hasError);&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;}<span class="cs__preproc">&nbsp;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;#endregion</span>&nbsp;
&nbsp;
&nbsp;&nbsp;&nbsp;　　　・&nbsp;
&nbsp;&nbsp;&nbsp;　　　・&nbsp;
&nbsp;&nbsp;&nbsp;　　　・&nbsp;
&nbsp;&nbsp;&nbsp;　　（略）&nbsp;
}</pre>
</div>
</div>
</div>
<div class="endscriptcode">&nbsp;続いて画面のコードを見ていきましょう。画面はForm1クラスになります。言い忘れましたが、本サンプルは、このForm1クラス、、既出のModelクラス、UIObjectクラスの３つから成っています。<br>
話を戻します。本サンプルでは、新規登録画面を想定しています。よって、以下に示すように全てのプロパティに空白をセットしています。この画面がもし変更画面であれば、空白の代わりに変更する前の値をセットすることになります。<br>
また、以下のようにIDataErrorInfoはErrorProviderと組み合わせると、エラーのある項目の横に自動的に赤マークを表示したり、エラー内容をToolTipで表示するようになります。ErrorProviderはツールボックスから画面にドラッグ＆どラップすることが多いと思いますが、以下のようにコードで設定することももちろんできます。その場合、ContainerControlプロパティとDataSourceプロパティを適切に設定する必要があります。</div>
<div class="endscriptcode">
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>C#</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">スクリプトの編集</span>|<span class="pluginRemoveHolderLink">Remove</span></div>
<span class="hidden">csharp</span>
<pre class="hidden">public partial class Form1 : Form
{
    ErrorProvider ep = new ErrorProvider();
    BindingSource bs = new BindingSource();
    Model model = new Model();
    UIObject uiobj = new UIObject();

    /// &lt;summary&gt;
    /// コンストラクタ
    /// &lt;/summary&gt;
    public Form1()
    {
        InitializeComponent();

        ep.ContainerControl = this;
        ep.DataSource = bs;
　　　　　・
　　　　　・
　　　　　（略）
　　　　　・
　　　　　・
        //初期値設定
        uiobj.A = &quot;&quot;;
        uiobj.B = &quot;&quot;;
        uiobj.C = &quot;&quot;;</pre>
<div class="preview">
<pre class="csharp"><span class="cs__keyword">public</span>&nbsp;partial&nbsp;<span class="cs__keyword">class</span>&nbsp;Form1&nbsp;:&nbsp;Form&nbsp;
{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;ErrorProvider&nbsp;ep&nbsp;=&nbsp;<span class="cs__keyword">new</span>&nbsp;ErrorProvider();&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;BindingSource&nbsp;bs&nbsp;=&nbsp;<span class="cs__keyword">new</span>&nbsp;BindingSource();&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;Model&nbsp;model&nbsp;=&nbsp;<span class="cs__keyword">new</span>&nbsp;Model();&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;UIObject&nbsp;uiobj&nbsp;=&nbsp;<span class="cs__keyword">new</span>&nbsp;UIObject();&nbsp;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__com">///&nbsp;&lt;summary&gt;</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__com">///&nbsp;コンストラクタ</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__com">///&nbsp;&lt;/summary&gt;</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__keyword">public</span>&nbsp;Form1()&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;InitializeComponent();&nbsp;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ep.ContainerControl&nbsp;=&nbsp;<span class="cs__keyword">this</span>;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ep.DataSource&nbsp;=&nbsp;bs;&nbsp;
　　　　　・&nbsp;
　　　　　・&nbsp;
　　　　　（略）&nbsp;
　　　　　・&nbsp;
　　　　　・&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__com">//初期値設定</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uiobj.A&nbsp;=&nbsp;<span class="cs__string">&quot;&quot;</span>;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uiobj.B&nbsp;=&nbsp;<span class="cs__string">&quot;&quot;</span>;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uiobj.C&nbsp;=&nbsp;<span class="cs__string">&quot;&quot;</span>;</pre>
</div>
</div>
</div>
<div class="endscriptcode">&nbsp;次に、起動直後の画面を表示します。</div>
<div class="endscriptcode"></div>
<div class="endscriptcode"><img id="136484" src="description/初期画面.JPG" alt="" width="436" height="345"></div>
&nbsp;</div>
<p>&nbsp;</p>
<p>エラーがある場合は次のようになります。</p>
<p>&nbsp;</p>
<p><img id="136485" src="description/エラー動作中.JPG" alt="" width="436" height="345"></p>
<p>&nbsp;</p>
<p>全てのテキストボックスはstring型にバインドしているおかげで、エラーがあっても各テキストボックスを自由に編集できます。もし、上のBがint型にバインドしている場合、エラーがある場合は既定ではBの入力から動けなくなります。FormのAutoValidateプロパティをEnableAllowFocusChangeにすればエラーがあってもその項目から離れることができるようになりますが、内部的にははじかれていますので、BプロパティのSetterのコードが実行されません。</p>
<p>本サンプルを動作させてみればわかりますが、入力する度にリアルタイムでエラーチェックが行われ、全てエラーが無くなるまで保存ボタンはEnableがfalseになり押せません。ただし、初期表示直後は押せるようになっています。初期表示には実際にはエラーでもエラー表示しておらず、これに同期させる必要があるからです。例えば、A項目は空白ではエラーですが、エラーになっていません。<br>
なお、リアルタイムでエラーチェックを行うために、バインドの引数を以下のように&nbsp;DataSourceUpdateMode.OnPropertyChanged にしています。</p>
<p>&nbsp;</p>
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>C#</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">スクリプトの編集</span>|<span class="pluginRemoveHolderLink">Remove</span></div>
<span class="hidden">csharp</span>
<pre class="hidden">public partial class Form1 : Form
{
    ErrorProvider ep = new ErrorProvider();
    BindingSource bs = new BindingSource();
    Model model = new Model();
    UIObject uiobj = new UIObject();

    /// &lt;summary&gt;
    /// コンストラクタ
    /// &lt;/summary&gt;
    public Form1()
    {
        InitializeComponent();

        bs.DataSource = uiobj;
        this.textBox1.DataBindings.Add(new <a class="libraryLink" href="https://code.msdn.microsoft.com/WindowsIDataErrorInfo-637ebea1/https://code.msdn.microsoft.com/WindowsIDataErrorInfo-637ebea1/https://msdn.microsoft.com/ja-JP/library/System.Windows.Forms.Binding.aspx"  title="Auto generated link to System.Windows.Forms.Binding">System.Windows.Forms.Binding</a>(&quot;Text&quot;, bs, &quot;A&quot;, true, DataSourceUpdateMode.OnPropertyChanged));</pre>
<div class="preview">
<pre class="csharp"><span class="cs__keyword">public</span>&nbsp;partial&nbsp;<span class="cs__keyword">class</span>&nbsp;Form1&nbsp;:&nbsp;Form&nbsp;
{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;ErrorProvider&nbsp;ep&nbsp;=&nbsp;<span class="cs__keyword">new</span>&nbsp;ErrorProvider();&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;BindingSource&nbsp;bs&nbsp;=&nbsp;<span class="cs__keyword">new</span>&nbsp;BindingSource();&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;Model&nbsp;model&nbsp;=&nbsp;<span class="cs__keyword">new</span>&nbsp;Model();&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;UIObject&nbsp;uiobj&nbsp;=&nbsp;<span class="cs__keyword">new</span>&nbsp;UIObject();&nbsp;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__com">///&nbsp;&lt;summary&gt;</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__com">///&nbsp;コンストラクタ</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__com">///&nbsp;&lt;/summary&gt;</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__keyword">public</span>&nbsp;Form1()&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;InitializeComponent();&nbsp;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bs.DataSource&nbsp;=&nbsp;uiobj;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__keyword">this</span>.textBox1.DataBindings.Add(<span class="cs__keyword">new</span>&nbsp;<a class="libraryLink" href="https://code.msdn.microsoft.com/WindowsIDataErrorInfo-637ebea1/https://code.msdn.microsoft.com/WindowsIDataErrorInfo-637ebea1/https://msdn.microsoft.com/ja-JP/library/System.Windows.Forms.Binding.aspx"  title="Auto generated link to System.Windows.Forms.Binding">System.Windows.Forms.Binding</a>(<span class="cs__string">&quot;Text&quot;</span>,&nbsp;bs,&nbsp;<span class="cs__string">&quot;A&quot;</span>,&nbsp;<span class="cs__keyword">true</span>,&nbsp;DataSourceUpdateMode.OnPropertyChanged));</pre>
</div>
</div>
</div>
<div class="endscriptcode">エラーが全て無くなれば以下のように、UIObjectからModelに値を書き戻しています。データベースを扱うような場合は、DataTableに書き戻し、そこからデータベースに書き戻すようにします。この辺りはADO.NETの基本的な仕組みを使うことになります。</div>
<div class="endscriptcode"></div>
<div class="endscriptcode">
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>C#</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">スクリプトの編集</span>|<span class="pluginRemoveHolderLink">Remove</span></div>
<span class="hidden">csharp</span>
<pre class="hidden">    /// &lt;summary&gt;
    /// 保存ボタンクリック
    /// &lt;/summary&gt;
    /// &lt;param name=&quot;sender&quot;&gt;&lt;/param&gt;
    /// &lt;param name=&quot;e&quot;&gt;&lt;/param&gt;
    private void bttn_保存_Click(object sender, EventArgs e)
    {
        uiobj.ValidateAll();
        ep.UpdateBinding();

        if (uiobj.HasError)
        {
            MessageBox.Show(&quot;以下のエラーのため、保存されませんでした。\r\n\r\n&quot; &#43; uiobj.Error, &quot;エラー有り&quot;, MessageBoxButtons.OK, MessageBoxIcon.Error);
        }
        else
        {
            model.A = uiobj.A;
            model.B = int.Parse(uiobj.B);
            model.C = decimal.Parse(uiobj.C);

            MessageBox.Show(&quot;保存されました。&quot;);
        }
    }</pre>
<div class="preview">
<pre class="csharp">&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__com">///&nbsp;&lt;summary&gt;</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__com">///&nbsp;保存ボタンクリック</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__com">///&nbsp;&lt;/summary&gt;</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__com">///&nbsp;&lt;param&nbsp;name=&quot;sender&quot;&gt;&lt;/param&gt;</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__com">///&nbsp;&lt;param&nbsp;name=&quot;e&quot;&gt;&lt;/param&gt;</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__keyword">private</span>&nbsp;<span class="cs__keyword">void</span>&nbsp;bttn_保存_Click(<span class="cs__keyword">object</span>&nbsp;sender,&nbsp;EventArgs&nbsp;e)&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uiobj.ValidateAll();&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ep.UpdateBinding();&nbsp;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__keyword">if</span>&nbsp;(uiobj.HasError)&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageBox.Show(<span class="cs__string">&quot;以下のエラーのため、保存されませんでした。\r\n\r\n&quot;</span>&nbsp;&#43;&nbsp;uiobj.Error,&nbsp;<span class="cs__string">&quot;エラー有り&quot;</span>,&nbsp;MessageBoxButtons.OK,&nbsp;MessageBoxIcon.Error);&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__keyword">else</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;model.A&nbsp;=&nbsp;uiobj.A;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;model.B&nbsp;=&nbsp;<span class="cs__keyword">int</span>.Parse(uiobj.B);&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;model.C&nbsp;=&nbsp;<span class="cs__keyword">decimal</span>.Parse(uiobj.C);&nbsp;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageBox.Show(<span class="cs__string">&quot;保存されました。&quot;</span>);&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;}</pre>
</div>
</div>
</div>
<div class="endscriptcode">&nbsp;</div>
</div>
<ul>
</ul>
<h1>ヒント</h1>
<p>本サンプルを変更画面として扱った場合、画面を閉じる際にUIObjectとModelを比較し、ユーザーがどこかの項目を変更した場合のみ、「このまま閉じると変更が失われますがよろしいですか？」等のメッセージを出すことができるようになります。実質、Modelが変更前、UIObjectが変更後の値を保持していることになります。これを利用すれば、項目単位で編集前にリセットすることも可能です。<br>
また、話が逸れてWPFの話になりますが、WPFの場合はUIObjectのバインド用プロパティを、全てstring型で定義する必要はなく、それぞれの本来の型で定義しても問題ありません。</p>

</div>


    </div>
</body>
</html>
