//-----------------------------------------------------------------------
// <copyright company="Microsoft Corporation">
//     Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
//-----------------------------------------------------------------------
using System;
using System.ComponentModel;
using System.Data;
using System.Data.SqlServerCe;
using System.Windows.Forms;
using Microsoft.Reporting.WinForms;

namespace RefreshData
{
    public partial class Form1 : Form
    {
        private SqlCeDataAdapter dataGridViewDataAdapter = new SqlCeDataAdapter();
        private BindingSource dataGridViewBindingSource = new BindingSource();
        private SqlCeCommandBuilder commandBuilder = null;

        public Form1()
        {
            InitializeComponent();
        }

        private void Form1_Load(object sender, EventArgs e)
        {
            // This line of code is automatically generated by the ReportViewer control to load data into the 'StudentGrades.Table1' 
            // table. This table is already bound to the LocalReport.DataSources property in Form1.Designer.cs.
            this.Table1TableAdapter.Fill(this.StudentGrades.Table1);

            // Run the report
            this.ReportViewer1.RefreshReport();

            // Subscribe to the ReportRefresh event so we can refresh data when the Refresh button is clicked.
            ReportViewer1.ReportRefresh += new CancelEventHandler(ReportViewer1_ReportRefresh);

            // Data bind the DataGridView object to the database file to independently change the records.
            DataGridViewStudentGrades.DataSource = dataGridViewBindingSource;
            GetData();

            // Subscribe to events for updating the database file.
            DataGridViewStudentGrades.RowValidated += new DataGridViewCellEventHandler(DataGridViewStudentGrades_RowValidated);
            DataGridViewStudentGrades.RowsRemoved += new DataGridViewRowsRemovedEventHandler(DataGridViewStudentGrades_RowsRemoved);
        }

        /// <summary>
        /// Handles the ReportViewer.ReportRefresh event and refreshes the data before report processing.
        /// </summary>
        private void ReportViewer1_ReportRefresh(object sender, CancelEventArgs e)
        {
            // Note here that 'StudentGrades.Table1' is already bound to the LocalReport.DataSources property, but the data
            // previously loaded into the table is now old if the underlying database has been updated. So we need to refill the
            // table with fresh data here.
            this.Table1TableAdapter.Fill(this.StudentGrades.Table1);
        }

        /// <summary>
        /// Handles the DataGridView.RowValidated event and updates the database file.
        /// </summary>
        private void DataGridViewStudentGrades_RowValidated(object sender, DataGridViewCellEventArgs e)
        {
            // Update the database with the user's changes.
            dataGridViewDataAdapter.Update((DataTable)dataGridViewBindingSource.DataSource);
        }

        /// <summary>
        /// Handles the DataGridView.RowsRemoved event and updates the database file.
        /// </summary>
        private void DataGridViewStudentGrades_RowsRemoved(object sender, DataGridViewRowsRemovedEventArgs e)
        {
            // Update the database with the user's changes.
            dataGridViewDataAdapter.Update((DataTable)dataGridViewBindingSource.DataSource);
        }

        /// <summary>
        /// Helper method for loading data from the database file into the DataGridView control.
        /// </summary>
        private void GetData()
        {
            DataTable table = null;

            try
            {
                dataGridViewDataAdapter = new SqlCeDataAdapter("SELECT * FROM Table1", @"Data Source=..\..\StudentGradesDB.sdf");

                // Create a command builder to generate SQL update, insert, and delete commands based on select
                // command. These are used to update the database.
                commandBuilder = new SqlCeCommandBuilder(dataGridViewDataAdapter);
                commandBuilder.GetUpdateCommand();

                // Populate a new data table and bind it to the BindingSource.
                table = new DataTable();
                dataGridViewDataAdapter.Fill(table);
                dataGridViewBindingSource.DataSource = table;
                table = null;

                // Resize the DataGridView columns to fit the newly loaded content.
                DataGridViewStudentGrades.AutoResizeColumns(DataGridViewAutoSizeColumnsMode.AllCellsExceptHeader);
            }
            finally
            {
                if (table != null)
                    table.Dispose();
            }
        }
    }
}
