# WCF Compression over HTTP sample
## Requires
- Visual Studio 2008
## License
- Apache License, Version 2.0
## Technologies
- WCF
- .NET
- IIS
## Topics
- Performance
## Updated
- 02/28/2011
## Description

<p>WCF service and client do not support HTTP Compression out of the box in .NET 3.5 even if you turn on Dynamic Compression in IIS 6 or 7. It has been fixed in .NET 4 but those who are stuck with .NET 3.5 for foreseeable future, you are out of luck.&nbsp;
 First of all, it&rsquo;s IIS fault that it does not enable http compression for SOAP messages even if you turn on Dynamic Compression in IIS 7. Secondly, it&rsquo;s WCF&rsquo;s fault that it does not send the Accept-Encoding: gzip, deflate header in http requests
 to the server, which tells IIS that the client supports compression. Thirdly, it&rsquo;s again WCF fault that even if you make IIS to send back compressed response, WCF can&rsquo;t process it since it does not know how to decompress it. So, you have to tweak
 IIS and System.Net factories to make compression work for WCF services. Compression is key for performance since it can dramatically reduce the data transfer from server to client and thus give significant performance improvement if you are exchanging medium
 to large data over WAN or internet.</p>
<p>There are two steps &ndash; first configure IIS, then configure System.Net. There&rsquo;s no need to tweak anything in WCF like using some Message Interceptor to inject HTTP Headers as you find people trying to do&nbsp;<a href="http://social.msdn.microsoft.com/Forums/en/wcf/thread/133f644c-1b44-4688-ade6-7c3b067bfb59">here</a>,&nbsp;<a href="http://stackoverflow.com/questions/2713203/gzip-compression-with-wcf-hosted-on-iis7">here</a>&nbsp;and&nbsp;<a href="http://stackoverflow.com/questions/10006/what-is-the-easiest-way-to-add-compression-to-wcf-in-silverlight">here</a>.</p>
<p>You need to add the following block in the&nbsp;<span style="text-decoration:underline">&lt;dynamicTypes&gt;</span>&nbsp;section of&nbsp;<span style="text-decoration:underline">applicationHost.config&nbsp;</span>file inside&nbsp;<span style="text-decoration:underline">C:\Windows\System32\inetsrv\config</span>&nbsp;folder.
 Be very careful about the space in&nbsp;<span style="text-decoration:underline">mimeType</span>. They need to be exactly the same as you find in response header of SOAP response generated by WCF services.</p>
<pre>&lt;add mimeType=&quot;application/soap&#43;xml&quot; enabled=&quot;true&quot; /&gt;
&lt;add mimeType=&quot;application/soap&#43;xml; charset=utf-8&quot; enabled=&quot;true&quot; /&gt;
&lt;add mimeType=&quot;application/soap&#43;xml; charset=ISO-8895-1&quot; enabled=&quot;true&quot; /&gt;</pre>
<p>After adding the block, the config file will look like this:</p>
<p><a href="http://omaralzabir.com/wp-content/uploads/2011/02/image1.png" target="_blank"><img title="image" src="-image_thumb1.png" border="0" alt="image" width="440" height="106"></a></p>
<p>For IIS 6, first you need to first&nbsp;<a href="http://omaralzabir.com/iis_6_compression___quickest_and_effective_way_to_do_it_for_asp_net_compression/">enable dynamic compression</a>&nbsp;and then allow the .svc extension so that IIS compresses responses
 from WCF services.</p>
<p>Next you need to make WCF send the&nbsp;<span style="text-decoration:underline">Accept-Encoding: gzip, deflate</span>&nbsp;header as part of request and then support decompressing a compressed response.</p>
<p>You need to override the System.Net default&nbsp;<span style="text-decoration:underline">WebRequest</span>&nbsp;creator to create&nbsp;<span style="text-decoration:underline">HttpWebRequest</span>with compression turned on. First you create a class like
 this:</p>
<div id="codeSnippetWrapper">
<pre id="codeSnippet" class="csharpcode"><div class="scriptcode"><div class="pluginEditHolder" pluginCommand="mceScriptCode"><div class="title"><span>C#</span></div><div class="pluginLinkHolder"><span class="pluginEditHolderLink">Edit</span>|<span class="pluginRemoveHolderLink">Remove</span></div><span class="hidden">csharp</span><pre class="hidden">public class CompressibleHttpRequestCreator : IWebRequestCreate
{
    public CompressibleHttpRequestCreator()
    {
    }

    WebRequest IWebRequestCreate.Create(Uri uri)
    {
        HttpWebRequest httpWebRequest =
            Activator.CreateInstance(typeof(HttpWebRequest),
            BindingFlags.CreateInstance | BindingFlags.Public |
            BindingFlags.NonPublic | BindingFlags.Instance,
            null, new object[] { uri, null }, null) as HttpWebRequest;

        if (httpWebRequest == null)
        {
            return null;
        }

        httpWebRequest.AutomaticDecompression = DecompressionMethods.GZip |
            DecompressionMethods.Deflate;

        return httpWebRequest;
    }
}</pre>
<div class="preview">
<pre class="js">public&nbsp;class&nbsp;CompressibleHttpRequestCreator&nbsp;:&nbsp;IWebRequestCreate&nbsp;
<span class="js__brace">{</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;CompressibleHttpRequestCreator()&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="js__brace">{</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="js__brace">}</span>&nbsp;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;WebRequest&nbsp;IWebRequestCreate.Create(Uri&nbsp;uri)&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="js__brace">{</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpWebRequest&nbsp;httpWebRequest&nbsp;=&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Activator.CreateInstance(<span class="js__operator">typeof</span>(HttpWebRequest),&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BindingFlags.CreateInstance&nbsp;|&nbsp;BindingFlags.Public&nbsp;|&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BindingFlags.NonPublic&nbsp;|&nbsp;BindingFlags.Instance,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;null,&nbsp;<span class="js__operator">new</span>&nbsp;object[]&nbsp;<span class="js__brace">{</span>&nbsp;uri,&nbsp;null&nbsp;<span class="js__brace">}</span>,&nbsp;null)&nbsp;as&nbsp;HttpWebRequest;&nbsp;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="js__statement">if</span>&nbsp;(httpWebRequest&nbsp;==&nbsp;null)&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="js__brace">{</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="js__statement">return</span>&nbsp;null;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="js__brace">}</span>&nbsp;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;httpWebRequest.AutomaticDecompression&nbsp;=&nbsp;DecompressionMethods.GZip&nbsp;|&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DecompressionMethods.Deflate;&nbsp;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="js__statement">return</span>&nbsp;httpWebRequest;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="js__brace">}</span>&nbsp;
<span class="js__brace">}</span>&nbsp;
&nbsp;
</pre>
</div>
</div>
</div>
<div class="endscriptcode"><span style="white-space:normal">Then on the WCF Client application&rsquo;s app.config or web.config, you need to put this block inside system.net which tells system.net to use your factory instead of the default one.</span></div>
</pre>
</div>
<div id="codeSnippetWrapper">
<pre id="codeSnippet" class="csharpcode"><div class="scriptcode"><div class="pluginEditHolder" pluginCommand="mceScriptCode"><div class="title"><span>XML</span></div><div class="pluginLinkHolder"><span class="pluginEditHolderLink">Edit</span>|<span class="pluginRemoveHolderLink">Remove</span></div><span class="hidden">xml</span><pre class="hidden">&lt;system.net&gt;
  &lt;webRequestModules&gt;
    &lt;remove prefix=&quot;http:&quot;/&gt;
    &lt;add prefix=&quot;http:&quot; type=&quot;WcfHttpCompressionEnabler.CompressibleHttpRequestCreator, WcfHttpCompressionEnabler, 
        Version=1.0.0.0, Culture=neutral, PublicKeyToken=null&quot; /&gt;
  &lt;/webRequestModules&gt;
&lt;/system.net&gt;</pre>
<div class="preview">
<pre class="xml"><span class="xml__tag_start">&lt;system</span>.net<span class="xml__tag_start">&gt;&nbsp;
</span>&nbsp;&nbsp;<span class="xml__tag_start">&lt;webRequestModules</span><span class="xml__tag_start">&gt;&nbsp;
</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="xml__tag_start">&lt;remove</span>&nbsp;<span class="xml__attr_name">prefix</span>=<span class="xml__attr_value">&quot;http:&quot;</span><span class="xml__tag_start">/&gt;</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="xml__tag_start">&lt;add</span>&nbsp;<span class="xml__attr_name">prefix</span>=<span class="xml__attr_value">&quot;http:&quot;</span>&nbsp;<span class="xml__attr_name">type</span>=<span class="xml__attr_value">&quot;WcfHttpCompressionEnabler.CompressibleHttpRequestCreator,&nbsp;WcfHttpCompressionEnabler,&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Version=1.0.0.0,&nbsp;Culture=neutral,&nbsp;PublicKeyToken=null&quot;</span>&nbsp;<span class="xml__tag_start">/&gt;</span>&nbsp;
&nbsp;&nbsp;<span class="xml__tag_end">&lt;/webRequestModules&gt;</span>&nbsp;
&lt;/system.net&gt;&nbsp;
&nbsp;
</pre>
</div>
</div>
</div>
<div class="endscriptcode"><span style="white-space:normal">That&rsquo;s it.</span></div>
</pre>
</div>
<p>Download the sample project that shows how I have done this.</p>
<p>&nbsp;</p>
<p>Always, check my blog for more performance and scalability tips.&nbsp;</p>
<p><a href="http://omaralzabir.com" target="_blank">http://omaralzabir.com</a></p>
